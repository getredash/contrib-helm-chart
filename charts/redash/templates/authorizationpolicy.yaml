---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
  {{- if .Values.resourceValidation.enabled }}
  labels:
    istio.io/tag: {{ default "stable" .Values.resourceValidation.istioRevisionTag }}
  {{- end }}
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ .Release.Name }}
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/infra/sa/uberproxy"
              # The config Job needs to call Redash's API
              - "cluster.local/ns/{{ .Release.Namespace }}/sa/{{ include "redash.serviceAccountName" . }}"
